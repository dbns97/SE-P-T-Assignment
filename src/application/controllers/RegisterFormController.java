package application.controllers;
import application.models.*;
import application.views.*;

import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;

import javafx.fxml.FXML;
import javafx.scene.control.Button;
import javafx.scene.control.Label;
import javafx.scene.control.PasswordField;
import javafx.scene.control.TextField;
import javafx.stage.Stage;

public class RegisterFormController {

	final static Logger logger = LogManager.getLogger(RegisterFormController.class.getName());

	private PublicMenu pm;
	@FXML
	private TextField businessName;
	@FXML
    private TextField username;
    @FXML
    private PasswordField password;
    @FXML
    private PasswordField reenter;
	@FXML
    private TextField name;
	@FXML
    private TextField address;
	@FXML
    private TextField contactNumber;
    @FXML
    private Button registerButton;
    @FXML
    private Label errorLabel;
    private Business business;

	public void setMainMenu(PublicMenu pm)
	{
		this.pm = pm;
	}

	public void handleBack()
	{
		pm.showPublicMenu();
	}

	public void setBusiness(Business business)
	{
		this.business = business;
	}

	public Business getBusiness()
	{
		return business;
	}

	public void setErrorLabel(Label l)
	{
		this.errorLabel = l;
	}

	public Label getErrorLabel()
	{
		return this.errorLabel;
	}

	public void setUsername(TextField username)
	{
		this.username = username;
	}

	public void setUsername(String username)
	{
		this.username.setText(username);
	}

	public TextField getUsername()
	{
		return this.username;
	}

	public void setPassword(PasswordField password)
	{
		this.password = password;
	}

	public void setPassword(String password)
	{
		this.password.setText(password);
	}

	public void setReenteredPassword(PasswordField password)
	{
		this.reenter = password;
	}

	public void setReenteredPassword(String password)
	{
		this.reenter.setText(password);
	}

	public void setName(TextField name)
	{
		this.name = name;
	}

	public void setName(String name)
	{
		this.name.setText(name);
	}

	public void setAddress(TextField address)
	{
		this.address = address;
	}

	public void setAddress(String address)
	{
		this.address.setText(address);
	}

	public void setContactNumber(TextField contactNumber)
	{
		this.contactNumber = contactNumber;
	}

	public void setContactNumber(String contactNumber)
	{
		this.contactNumber.setText(contactNumber);
	}

	public void setRegisterButton(Button registerButton)
	{
		this.registerButton = registerButton;
	}

	public boolean handleRegister()
	{
		errorLabel.setWrapText(true);

		// Check if business name entered is valid
		if (DatabaseHandler.businessExists(businessName.getText())) {
			business = new Business(businessName.getText());
		} else {
			errorLabel.setText("Business entered doesn't exist");
			return false;
		}

		/*
		if(username.getText().trim().isEmpty() || !(username.getText().matches("[a-zA-z0-9]+")))
		{
			errorLabel.setText("Please enter a username without symbols or whitespace");
			logger.debug("incorrect syntax with username");
			return false;
		}

		if(password.getText().isEmpty())
		{
			errorLabel.setText("Please enter a password");
			return false;
		}

		if(reenter.getText().isEmpty() || !reenter.getText().equals(password.getText()))
		{
			errorLabel.setText("Please re-enter your password");
			return false;
		}

		if(!(name.getText().matches("[a-zA-z ,.'-]+")) || name.getText().trim().isEmpty())
		{
			errorLabel.setText("Please enter a name without numbers or symbols");
			logger.debug("incorrect syntax with entered name");
			return false;
		}

		if(!(address.getText().matches("[a-zA-z0-9 ,.'-]+")) || address.getText().trim().isEmpty())
		{
			errorLabel.setText("Please enter an address without symbols");
			logger.debug("incorrect syntax with address");
			return false;
		}

		if(!(contactNumber.getText().matches("[0-9]+")) || contactNumber.getText().trim().isEmpty())
		{
			errorLabel.setText("Please enter a contact number with only numbers");
			logger.debug("incorrect syntax with contact number");
			return false;
		}

		// Checks the business's customers to see if the username already exists
		for (Customer customer : business.getCustomers())
		{
			if (customer.getUsername().equals(username.getText()))
			{
				errorLabel.setText("Username already exists");
				return false;
			}
		}
		*/
		String errorMessage = checkRegisterDetails(username.getText(), password.getText(), reenter.getText(), name.getText(), address.getText(), contactNumber.getText(), business);
		if(!(errorMessage == null))
		{
			errorLabel.setText(errorMessage);
			return false;
		}
		
		Customer newUser = new Customer(username.getText(), name.getText(), password.getText());

		business.addCustomer(newUser);

		errorLabel.setText("Successfully registered " + username.getText());
		DatabaseHandler.writeBusinessToFile(business);
		login(newUser);
		logger.info("new user added to system : {}", username.getText());
		return true;

	}
	
	public String checkRegisterDetails(String username, String password, String reenter, String name, String address, String contactNumber, Business business) {
		if (username.trim().isEmpty() || !(username.matches("[a-zA-z0-9]+"))) {
			logger.debug("incorrect syntax with username");
			return "Please enter a username without symbols or whitespace";
		}

		if (password.isEmpty()) {
			return "Please enter a password";
		}

		if (reenter.isEmpty() || !reenter.equals(password)) {
			return "Please re-enter your password";
		}

		if (!(name.matches("[a-zA-z ,.'-]+")) || name.trim().isEmpty()) {
			logger.debug("incorrect syntax with entered name");
			return "Please enter a name without numbers or symbols";
		}

		if (!(address.matches("[a-zA-z0-9 ,.'-]+")) || address.trim().isEmpty()) {
			logger.debug("incorrect syntax with address");
			return "Please enter an address without symbols";
		}

		if (!(contactNumber.matches("[0-9]+")) || contactNumber.trim().isEmpty()) {
			logger.debug("incorrect syntax with contact number");
			return "Please enter a contact number with only numbers";
		}

		// Checks the business's customers to see if the username already exists
		for (Customer customer : business.getCustomers()) {
			if (customer.getUsername().equals(username)) {
				return "Username already exists";
			}
		}
		logger.debug("Details correct");
		return null;
	}

	private void login(Customer customer) {
		CustomerMenu menu = new CustomerMenu();
		menu.setBusiness(business);
		menu.setMainMenu(pm);
		menu.setCustomer(customer);
		Stage stage = (Stage) registerButton.getScene().getWindow();
		try
		{
			menu.start(stage);
		} catch(Exception e) {
			e.printStackTrace();
		}
	}
	
	public boolean checkBusinessUsers(String username, Business business)
	{
		for (Customer customer : business.getCustomers())
		{
			if (customer.getUsername().equals(username))
			{
				return false;
			}
		}
		return true;
	}
}
